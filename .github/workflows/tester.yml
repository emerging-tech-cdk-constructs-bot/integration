on: 
  workflow_dispatch:
    inputs:
      pullRequestNumber:
        type: string
        required: true
        default: '2'
      checkRunId:
        type: string
        required: true
        default: '25237483792'
jobs:
  tester:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    permissions:
      id-token: write
      contents: read
      checks: write
      pull-requests: read
    steps:
      - name: Echo the event
        run: |
          cat << OBJECT
          ${{ toJson(github) }}
          OBJECT
      - name: Inputs
        run: |
          cat << OBJECT
          ${{ toJson(inputs) }}
          OBJECT
      - name: GitHub CLI version
        run: gh --version
      - name: stuff
        run: echo ${{github.event.repository.name}} ${{github.event.repository.owner.login}} ${{inputs.pullRequestNumber}} ${{inputs.checkRunId}}
      - name: Run GitHub API GraphQL
        id: graphql
        run: |
          echo checkRun=`gh api graphql \
              --raw-field repositoryName="${{github.event.repository.name}}" \
              --raw-field repositoryOwner="${{github.event.repository.owner.login}}" \
              --field pullRequestNumber="${{inputs.pullRequestNumber}}" \
              --field query='query($repositoryName: String!, $repositoryOwner: String!, $pullRequestNumber: Int!){
                repository(followRenames: true, name: $repositoryName, owner: $repositoryOwner) {
                  pullRequest(number: $pullRequestNumber) {
                    state
                    reviewDecision
                    mergeable
                    statusCheckRollup {
                      contexts(first: 100) {
                        checkRunCount
                        nodes {
                          ... on CheckRun {
                            id
                            isRequired(pullRequestNumber: $pullRequestNumber)
                            name
                            status
                            databaseId
                            externalId
                            conclusion
                            summary
                            text
                            title
                          }
                        }
                      }
                    }
                  }
                }
              }' | jq -c '.data.repository.pullRequest | select (.state == "OPEN") | select (.reviewDecision == "APPROVED") | select (.mergeable == "MERGEABLE") | .statusCheckRollup.contexts.nodes[] | select (.databaseId == ${{ inputs.checkRunId }}) | .'` >> "$GITHUB_OUTPUT"
      - name: Debug the GitHub API GraphQL output
        run: |
          cat << OBJECT
          ${{ toJSON(steps.graphql.outputs) }}
          OBJECT
      - name: Debug the GitHub API GraphQL checkRun
        run: |
          cat << OBJECT
          ${{ steps.graphql.outputs.checkRun }}
          OBJECT
      - name: Debug the GitHub API GraphQL checkRun
        run: |
          cat << OBJECT
          ${{ toJSON(steps.graphql.outputs.checkRun) }}
          OBJECT
      - name: Debug the GitHub API GraphQL checkRun's externalId
        run: |
          cat << OBJECT
          ${{ toJSON(steps.graphql.outputs.checkRun.externalId) }}
          OBJECT
      - name: Set the properties
        id: props
        run: |
          echo status=`echo '${{ steps.graphql.outputs.checkRun }}' | jq -c '.status'` >> "$GITHUB_OUTPUT";
      - name: If the check run status is completed
        if: steps.props.outputs.status == 'COMPLETED'
        run: echo "COMPLETED ${{ steps.props.outputs.status }}"
      - name: If the status is not completed
        if: steps.props.outputs.status != 'COMPLETED'
        run: echo "NOT COMPLETED ${{ steps.props.outputs.status }}"
      # - name: ExternalId
      #   run: echo "This is the externalId '${{ steps.graphql.outputs.checkRun.externalId }}'"    
